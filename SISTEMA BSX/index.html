<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FINX.IA - Sistema de Gest√£o</title>    

  <link rel="stylesheet" href="css/app.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="alertas-despesas.css">
  <link rel="stylesheet" href="css/mobile-fixes.css">
  <link rel="stylesheet" href="css/dashboard-mobile-fix.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <!-- LOGIN -->
  <section id="loginPage">
    <div class="login-box">
      <h1 class="brand-title neon" aria-label="FINX.IA">
        FINX<span class="dot">.</span>IA
      </h1>      
      <label for="loginUser">Usu√°rio</label>
      <input type="text" id="loginUser" placeholder="Digite seu usu√°rio" />
      <label for="loginPass">Senha</label>
      <input type="password" id="loginPass" placeholder="Digite sua senha" />
      <button id="btnDoLogin">Entrar</button>
      <div class="error" id="loginError">Usu√°rio ou senha incorretos.</div>
    </div>
  </section>

  <!-- APP -->
<section id="app" style="display:none">
  <!-- LAYOUT COM SIDEBAR -->
  <div class="layout">

    <!-- SIDEBAR ESQUERDA -->
    <div id="overlay"></div>
    <aside id="sidebar" aria-label="Menu lateral">
      <div class="sb-top">
        <div class="logo neon" aria-label="FINX.IA">
          FINX<span class="dot">.</span>IA
        </div>        
        <button id="sbClose" class="sb-close" aria-label="Fechar menu">√ó</button>
      </div>

      <nav class="sb-nav" id="sbNav">
<!-- In√≠cio -->
<button class="sb-item" data-tab="home" data-perm="inicio_view" aria-label="In√≠cio" title="In√≠cio">
  <span class="ico" aria-hidden="true">
    <!-- home -->
    <svg viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5v9A1.5 1.5 0 0 1 19.5 21h-3A1.5 1.5 0 0 1 15 19.5V15H9v4.5A1.5 1.5 0 0 1 7.5 21h-3A1.5 1.5 0 0 1 3 19.5v-9Z"/></svg>
  </span>
  <span class="label">In√≠cio</span>
</button>

<!-- Cadastros (grupo recolh√≠vel) -->
<button class="sb-item sb-group" data-group="cad" aria-expanded="false" aria-label="Cadastros" title="Cadastros">
  <span class="ico" aria-hidden="true">
    <!-- folder -->
    <svg viewBox="0 0 24 24"><path d="M3 6.75A1.75 1.75 0 0 1 4.75 5h4.5L11 7h8.25A1.75 1.75 0 0 1 21 8.75v8.5A1.75 1.75 0 0 1 19.25 19H4.75A1.75 1.75 0 0 1 3 17.25v-10.5Z"/></svg>
  </span>
  <span class="label">Cadastros</span>
  <span class="chev" aria-hidden="true">
    <!-- chevron -->
    <svg viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"/></svg>
  </span>
</button>
<nav class="sb-sub" data-sub="cad" hidden>
  <!-- Gerentes --> 
  <button class="sb-subitem" data-tab="cad" data-perm="cad_gerentes_view" title="Cadastro Gerentes">
    <span class="ico" aria-hidden="true">
      <!-- id-card -->
      <svg viewBox="0 0 24 24"><path d="M3 6.75A1.75 1.75 0 0 1 4.75 5h14.5A1.75 1.75 0 0 1 21 6.75v10.5A1.75 1.75 0 0 1 19.25 19H4.75A1.75 1.75 0 0 1 3 17.25V6.75Zm4 8.25h6M7 9.5h10"/></svg>
    </span>
    <span class="label">Cadastro Gerentes</span>
  </button>

  <button class="sb-subitem" data-tab="fich" data-perm="cad_fichas_view" title="Fichas">
    <span class="ico" aria-hidden="true">
      <!-- tickets -->
      <svg viewBox="0 0 24 24"><path d="M3 8h18v8H3zM7 8v8M17 8v8"/></svg>
    </span>
    <span class="label">Fichas</span>
  </button>
</nav>


<!-- Presta√ß√µes (grupo) -->
<button class="sb-item sb-group" data-group="prest" aria-expanded="false" aria-label="Presta√ß√µes" title="Presta√ß√µes">
  <span class="ico" aria-hidden="true">
    <svg viewBox="0 0 24 24"><path d="M8 4h8v3H8zM6.5 5H5A1.5 1.5 0 0 0 3.5 6.5v12A1.5 1.5 0 0 0 5 20h14a1.5 1.5 0 0 0 1.5-1.5v-12A1.5 1.5 0 0 0 19 5h-1.5"/></svg>
  </span>
  <span class="label">Presta√ß√µes</span>
  <span class="chev" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"/></svg></span>
</button>

<nav class="sb-sub" data-sub="prest" hidden>
  <button class="sb-subitem" data-tab="prest" data-perm="prest_lancar_view" aria-label="Lan√ßar presta√ß√£o" title="Lan√ßar presta√ß√£o">
    <span class="label">Lan√ßar presta√ß√£o</span>
  </button>

  <button class="sb-subitem" data-tab="prest-rel" data-perm="prest_rel_view" aria-label="Relat√≥rios de presta√ß√µes" title="Relat√≥rios de presta√ß√µes">
    <span class="label">Relat√≥rios</span>
  </button>

  <button class="sb-subitem" data-tab="prest-fech" data-perm="prest_fech_view" aria-label="Presta√ß√µes finalizadas" title="Presta√ß√µes finalizadas">
    <span class="label">Finalizadas</span>
  </button>

  <button class="sb-subitem" data-tab="prest-vales" data-perm="vales_view" aria-label="Vales" title="Vales">
    <span class="label">Vales</span>
  </button>
  


</nav>


<!-- Financeiro -->
<button class="sb-item" data-tab="fin" data-perm="financeiro_view" aria-label="Financeiro" title="Financeiro">
  <span class="ico" aria-hidden="true">
    <!-- wallet -->
    <svg viewBox="0 0 24 24"><path d="M3.5 7.5A2.5 2.5 0 0 1 6 5h12.5A2.5 2.5 0 0 1 21 7.5V9h-5.5A2.5 2.5 0 0 0 13 11.5v1A2.5 2.5 0 0 0 15.5 15H21v1.5A2.5 2.5 0 0 1 18.5 19H6A2.5 2.5 0 0 1 3.5 16.5v-9Z"/></svg>
  </span>
  <span class="label">Financeiro</span>
</button>

<!-- USU√ÅRIOS (s√≥ aparece para admin) -->
<!-- Sidebar -->
 
<button class="sb-item" data-tab="users" data-perm="admin_only" aria-label="Usu√°rios" title="Usu√°rios">
  <span class="ico" aria-hidden="true">
    
    <!-- √≠cone ‚Äúgrupo/usu√°rios‚Äù no mesmo estilo (SVG 24) -->
    <svg viewBox="0 0 24 24" width="24" height="24" fill="none"
         stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
      <!-- pessoa principal -->
      <circle cx="9" cy="7" r="3"></circle>
      <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
      <!-- pessoa secund√°ria -->
      <path d="M21 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M16 3.13a3 3 0 0 1 0 5.75"></path>
    </svg>
  </span>
  <span class="label">Usu√°rios</span>
</button>

<button class="sb-item" data-tab="historico" data-perm="admin_only">
  <span class="ico">üìú</span>
  <span class="label">Hist√≥rico</span>
</button>



<!-- Despesas -->
<button class="sb-item" data-tab="desp" data-perm="despesas_view" aria-label="Despesas" title="Despesas">
  <span class="ico" aria-hidden="true">
    <!-- receipt -->
    <svg viewBox="0 0 24 24"><path d="M6 3 8 4.5 10 3 12 4.5 14 3 16 4.5 18 3v18l-2-1.5-2 1.5-2-1.5-2 1.5-2-1.5-2 1.5V3Z"/></svg>
  </span>
  <span class="label">Despesas</span>
</button>

<!-- Relat√≥rios -->

<nav class="sb-sub" data-sub="rel" hidden>
  <button class="sb-subitem" data-tab="prest-rel" aria-label="Presta√ß√µes salvas" title="Presta√ß√µes salvas">
    <span class="ico" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M4 20V6M10 20V10M16 20V4M3 20h18"/></svg>
    </span>
    <span class="label">Presta√ß√µes salvas</span>
  </button>
  <button class="sb-subitem" data-tab="prest-fech" aria-label="Resultado de Presta√ß√µes" title="Resultado de Presta√ß√µes">
    <span class="ico" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M3 6h18v12H3zM7 9h10"/></svg>
    </span>
    <span class="label">Resultado de Presta√ß√µes</span>
  </button>

</nav>

<div class="sb-bottom">
  <span class="user-badge" id="userBadge">Logado</span>

  <div class="sb-actions">
    <!-- bot√£o toggle sidebar -->
    <button class="btn secondary" id="btnToggleSidebar" aria-label="Alternar menu" title="Alternar menu">
      <span class="ico" aria-hidden="true">
        <!-- √≠cone: setas esquerda/direita -->
        <svg viewBox="0 0 24 24">
          <path d="M4 12h16M10 6l-6 6 6 6M14 6l6-6-6 6z"/>
        </svg>
      </span>
      <span class="label">Compactar</span>
    </button>

    <button class="btn secondary" id="btnLogout" aria-label="Sair" title="Sair" data-action="logout">
      <span class="ico" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M16 17l5-5-5-5M21 12H9M13 19H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7"/></svg>
      </span>
      <span class="label">Sair</span>
    </button>
  </div>
</div>
</aside>

    <!-- TOPO -->
    <header class="topbar">
      <!-- 1. Chat IA -->
      <button id="btnAI" class="btn secondary" title="Assistente IA">üí¨</button>
      
      <!-- 2. Seletor de Empresas -->
      <select id="empresaSelect" class="user-badge" style="background:#222;color:#fff;border:1px solid #000;border-radius:8px;padding:6px 10px;">
        <option value="BSX">BSX</option>
        <option value="BetPlay">BetPlay</option>
        <option value="Emanuel">Emanuel</option>
      </select>
            
      <!-- 4. Menu Toggle -->
      <button id="menuToggle" class="sb-open" aria-label="Abrir menu">‚ò∞</button>

        <script>
(function(){
  const getC = window.getCompany || (() => (localStorage.getItem('CURRENT_COMPANY') || 'BSX'));
  const setC = window.setCompany || (c => { localStorage.setItem('CURRENT_COMPANY', c || 'BSX'); location.reload(); });

  const DISPLAY = { BSX:'BSX', EMANUEL:'Emanuel', BETPLAY:'BetPlay' };

  function syncSelects(c){
    document.querySelectorAll('[data-company-select],#empresaSelect').forEach(sel=>{
      const up = String(c||'BSX').toUpperCase();
      let matched = false;

      // marca a option certa ignorando caixa
      Array.from(sel.options).forEach(opt=>{
        const isMatch = String(opt.value||'').toUpperCase() === up;
        opt.selected = isMatch;
        if (isMatch) matched = true;
      });
      // garante que sel.value fica coerente (sem ‚Äúvalor em branco‚Äù)
      if (!matched) {
        const hit = Array.from(sel.options).find(o => String(o.value||'').toUpperCase() === up);
        if (hit) sel.value = hit.value;
      }

      if (!sel._binded){
        sel.addEventListener('change', e => setC(e.target.value));
        sel._binded = true;
      }
    });
  }

  function syncLabels(c){
    const up = String(c||'BSX').toUpperCase();
    const nice = DISPLAY[up] || up;
    document.querySelectorAll('[data-company-label]').forEach(el=> el.textContent = nice);
    document.documentElement.dataset.company = up;
  }

  function render(){ const c = getC(); syncSelects(c); syncLabels(c); }

  document.addEventListener('DOMContentLoaded', render);
  window.addEventListener('pageshow', render);
  window.addEventListener('storage', e=> { if(e.key==='CURRENT_COMPANY') render(); });

  window.renderCompanyUI = render;
})();
</script>
        

    </header>

<main id="content">
    <!-- IN√çCIO (Dashboard) -->
    <section id="pageInicio" class="container" data-perm="inicio_view">
      <!-- Dashboard do In√≠cio -->
      <div class="dash-grid">

        <!-- CAIXA (menor) -->
        <section class="card card-caixa" style="grid-area: caixa;">
          <div class="hero">
            <div class="title">üí∞ Caixa</div>
            <div class="saldo" id="dashSaldo">R$ 0,00</div>
          </div>
          <div class="bar">
            <span class="badge">Saldo do m√™s</span>
            <input id="dashMes" type="month">
          </div>
        </section>


        <!-- ALERTAS -->
        <section class="card card-alertas" style="grid-area: alertas;">
          <div class="card-title">‚ö†Ô∏è Alertas de despesas</div>
          <div id="dashAlertBox"><p class="muted">Tudo certo por aqui.</p></div>
        </section>
      
        <!-- PAINEL (desmembrado da tabela) -->
        <section class="card card-painel" style="grid-area: painel;">
          <div class="card-title">Painel</div>
          <ul class="kpis">
            <li><span>Total a receber:</span> <strong id="dashResTotValor">‚Äî</strong></li>
            <li><span>Total recebido:</span> <strong id="dashResTotRec">‚Äî</strong></li>
            <li><span>Total em aberto:</span> <strong id="dashResTotAber">‚Äî</strong></li>
            <li><span>Total pagamentos:</span> <strong id="dashResTotPag">‚Äî</strong></li>
            <li><span>% Recebidos:</span> <strong id="dashResPerc">‚Äî</strong></li>
          </ul>
          <hr>
          <div class="maior">
            <span>Maior inadimpl√™ncia:</span> <strong id="dashResMaior">‚Äî</strong>
          </div>
        </section>
      
        <!-- TABELA: Resultado de Presta√ß√µes (abertas) -->
        <section class="card card-tabela" style="grid-area: tabela;">
          <div class="card-title">Resultado de Presta√ß√µes (abertas)</div>
      
          <div class="tool-row">
            <input id="dashResBusca" placeholder="Buscar gerente">
            <button id="dashResAtualizar" class="btn">Atualizar</button>
            <button id="dashResImprimir" class="btn ghost">Imprimir</button>
          </div>
      
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>NOME</th><th>VALOR</th><th>SITUA√á√ÉO</th>
                  <th>RESTANTE</th><th>ADIANTAMENTO</th><th>RECEBIDO</th>
                </tr>
              </thead>
              <tbody id="dashResBody">
                <tr><td colspan="6">Carregando‚Ä¶</td></tr>
              </tbody>
              <tfoot id="dashResFoot"></tfoot>
            </table>
          </div>
        </section>
      </div>
      </section>
      
      <!-- ===== P√ÅGINA HIST√ìRICO/AUDITORIA ===== -->
      <section id="pageHistorico" class="container hidden" data-perm="admin_only">
        <header style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
          <h2 style="margin:0; display:flex; align-items:center; gap:10px;">
            üìú Hist√≥rico do Sistema
          </h2>
        </header>

        <div class="card">
          <div class="audit-filters">
            <div class="filters" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
              <div class="field">
                <label>Usu√°rio</label>
                <select id="auditFilterUser" class="input">
                  <option value="">Todos</option>
                </select>
              </div>

              <div class="field">
                <label>Empresa</label>
                <select id="auditFilterCompany" class="input">
                  <option value="">Todas</option>
                  <option value="BSX">BSX</option>
                  <option value="BETPLAY">BetPlay</option>
                  <option value="EMANUEL">Emanuel</option>
                </select>
              </div>

              <div class="field">
                <label>A√ß√£o</label>
                <input type="text" id="auditFilterAction" class="input" placeholder="Ex: gerente, prestacao" />
              </div>

              <div class="field">
                <label>Data Inicial</label>
                <input type="date" id="auditFilterStartDate" class="input" />
              </div>

              <div class="field">
                <label>Data Final</label>
                <input type="date" id="auditFilterEndDate" class="input" />
              </div>
            </div>

            <div class="audit-actions" style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap;">
              <button type="button" class="btn" id="btnAuditFilter">
                üîç Filtrar
              </button>
              <button type="button" class="btn" id="btnAuditExport">
                üì• Exportar CSV
              </button>
              <button type="button" class="btn danger" id="btnAuditClear">
                üóëÔ∏è Limpar Antigos
              </button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:20px;">
          <div class="table-wrap" style="max-height:calc(100vh - 450px); overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="min-width:140px;">Data/Hora</th>
                  <th style="min-width:120px;">Usu√°rio</th>
                  <th style="min-width:100px;">Empresa</th>
                  <th style="min-width:150px;">A√ß√£o</th>
                  <th>Detalhes</th>
                </tr>
              </thead>
              <tbody id="auditTableBody">
                <tr>
                  <td colspan="5" style="text-align:center; padding:40px; color:#999;">
                    Carregando hist√≥rico...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div id="auditStats" style="display:none;">
            <strong>Estat√≠sticas:</strong>
            <span id="auditStatsText"></span>
          </div>
        </div>
      </section>
      
      <!-- ===== P√ÅGINA USU√ÅRIOS ===== -->
      <section id="pageUsers" class="container hidden" data-perm="admin_only">
        <div class="card">
          <h3>Gerenciar usu√°rios</h3>
          <form id="userForm" class="form-grid">
            <label>Usu√°rio
              <input name="username" required>
            </label>
            <label>Senha
              <input name="password" type="password" required>
            </label>
            <div style="grid-column:1/-1">
              <strong>Permiss√µes do operador</strong>
              <div id="permGrid" class="row" style="margin-top:8px"></div>
            </div>            
            <div><button class="btn" type="submit">Criar operador</button></div>
          </form>
        </div>
      
        <div class="card users-pane">
          <h3>Usu√°rios</h3>
          <div class="table-wrap">
            <table id="userTable">
              <thead>
                <tr><th>Usu√°rio</th><th>Perfil</th><th>Permiss√µes</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
</section>

    <!-- ====== P√ÅGINA: CADASTROS ====== -->
    <section id="pageCadastros" class="container hidden" data-perm="cad_gerentes_view">
      
      <div class="grid">
        <div class="card">
          <h3>Cadastro de Gerentes</h3>
          <form id="formGerente" class="form-grid">
            <label>Nome
              <input name="nome" required placeholder="Ex.: Diego Silva" />
            </label>
            <label>N√∫mero (telefone)
              <input name="numero" required placeholder="(00) 90000-0000" />
            </label>
            <label>Endere√ßo
              <input name="endereco" required placeholder="Rua, n¬∫" />
            </label>
            <label>Telefone
              <input name="telefone" placeholder="(00) 90000-0000" />
            </label>
            <label>Email
              <input name="email" type="email" placeholder="email@exemplo.com" />
            </label>
            
            <!-- COMISS√ÉO PRINCIPAL -->
            <label>Comiss√£o (%)
              <select name="comissao" required>
                <option value="0">0%</option>
                <option value="10">10%</option>
                <option value="20">20%</option>
                <option value="25">25%</option>
                <option value="30">30%</option>
                <option value="40">40%</option>
                <option value="50">50%</option>
              </select>
            </label>
            
            <!-- OP√á√ïES DE C√ÅLCULO -->
            <div style="grid-column:1/-1; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #f8fafc;">
              <strong style="display:block; margin-bottom:10px;">Configura√ß√µes de Comiss√£o:</strong>
              
              <!-- Forma de c√°lculo -->
              <label style="display:block; margin-bottom:10px;">
                <strong>Base de C√°lculo da Comiss√£o:</strong>
                <select name="baseCalculo" id="baseCalculo" style="width:100%; margin-top:5px;">
                  <option value="coletas-despesas">Coletas - Despesas (padr√£o)</option>
                  <option value="coletas">Apenas Coletas</option>
                </select>
              </label>
              
              <!-- Comiss√£o por rota positiva -->
              <label style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                <input type="checkbox" name="comissaoPorRotaPositiva" id="pcPorRota">
                <span>Comiss√£o por rota (ignora rotas negativas)</span>
              </label>
              
              <!-- Segunda comiss√£o -->
              <label style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                <input type="checkbox" name="temSegundaComissao" id="temSegundaComissao">
                <span>Habilitar 2¬™ Comiss√£o</span>
              </label>
              
              <!-- Campo da 2¬™ comiss√£o (aparece s√≥ quando marcado) -->
              <div id="segundaComissaoDiv" style="display:none; margin-top:10px;">
                <label>2¬™ Comiss√£o (%)
                  <input name="comissao2" id="pcPerc2" type="number" min="0" max="100" step="0.01" placeholder="Ex: 5">
                </label>
              </div>
            </div>
            
            <label style="grid-column:1/-1">Observa√ß√µes
              <textarea name="obs"></textarea>
            </label>
            
            <div style="grid-column:1/-1;display:flex;gap:10px;justify-content:flex-end;margin-top:6px">
              <button type="button" id="btnLimparGerente" class="btn ghost">Limpar</button>
              <button type="submit" id="btnSalvarGerente" class="btn">Salvar</button>
            </div>
          </form>
          
          <script>
          // Mostrar/esconder campo da 2¬™ comiss√£o
          document.getElementById('temSegundaComissao').addEventListener('change', function(e) {
            const div = document.getElementById('segundaComissaoDiv');
            div.style.display = e.target.checked ? 'block' : 'none';
            if (!e.target.checked) {
              document.getElementById('pcPerc2').value = '';
            }
          });
          
          // Se marcar comiss√£o por rota, for√ßa base de c√°lculo para "Apenas Coletas"
          document.getElementById('pcPorRota').addEventListener('change', function(e) {
            if (e.target.checked) {
              document.getElementById('baseCalculo').value = 'coletas';
            }
          });
          </script>

        <div class="card">
          <h3>Gerentes cadastrados</h3>
          <div style="max-height:380px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px">
            <table id="tblGerentes">
              <thead>
                <tr>
                  <th>Nome</th><th>N√∫mero</th><th>Endere√ßo</th><th>Telefone</th><th>Email</th><th>Comiss√£o</th><th>Obs</th><th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbodyGerentes"></tbody>
            </table>
          </div>
          <small style="color:#6b7280;display:block;margin-top:8px">Dica: use EDITAR para atualizar um cadastro. Excluir somente ADMIN.</small>
        </div>
      </div>
    </section>

    <!-- ====== P√ÅGINA: PRESTA√á√ïES ====== -->
    <section id="pagePrestacoes" class="container hidden" data-perm="prest_lancar_view">
      <div id="prestContas" class="card" style="margin-top:18px">
        <h3>Presta√ß√µes de Contas</h3>

        <div class="pc-layout">
          <!-- COLUNA ESQUERDA -->
          <div class="pc-box left-box">
            <!-- Gerente e Per√≠odo -->
            <div class="row">
              <div class="field">
                <label>Gerente</label>
                <select id="pcGerente"></select>
              </div>
              <label for="pcGerente">
                Gerente
                <button 
                  type="button"
                  onclick="abrirModalAjusteSaldo()"
                  title="Ajustar saldo manualmente"
                  style="
                    background: transparent;
                    border: 1px solid #ddd;
                    padding: 6px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    color: #666;
                    margin-left: 8px;
                  "
                >
                  ‚öôÔ∏è
                </button>
              </label>

              <div class="field">
                <label>Per√≠odo (in√≠cio)</label>
                <input type="date" id="pcIni" />
              </div>
              <div class="field">
                <label>Per√≠odo (fim)</label>
                <input type="date" id="pcFim" />
              </div>
            </div>



<!-- COLETAS DO GERENTE (√∫nico bloco) -->
<div class="card" style="margin-top:10px">
  <h4>Coletores do gerente</h4>

  <div class="form-grid" style="grid-template-columns:2fr 1fr auto; margin-bottom:8px">
    <label>Usu√°rio
      <input type="text" id="colNome" placeholder="ex.: 005 Wewerton" />
    </label>
    <label>Valor (R$)
      <input id="colValor" inputmode="decimal" pattern="[0-9.,]*" placeholder="0,00" />
    </label>
    <button class="btn" id="btnColAdd" style="align-self:end">Adicionar coletor</button>
  </div>

  <div class="pc-actions" style="margin-bottom:8px">
    <button class="btn ghost" id="btnPcSalvarColetores">Salvar como padr√£o</button>
  </div>

  <div style="max-height:220px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px">
    <table>
      <thead>
        <tr><th>Usu√°rio</th><th>Valor</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody id="pcColetasBody"></tbody>
      <tfoot>
        <tr><th>Total</th><th id="pcColetasTotal">R$ 0,00</th><th></th></tr>
      </tfoot>
    </table>
  </div>
  <small style="color:#6b7280;display:block;margin-top:6px">
    Adicione coletores aqui. Eles j√° contam no total da presta√ß√£o.  
    Clique em "Salvar como padr√£o" para fixar no gerente.
  </small>
</div>

            <!-- RESUMO (campos manuais + resultados) -->
            <div class="card" style="margin-top:10px">
              <h4>Resumo</h4>
              <div class="row">
                <div class="field"><label>Valor Extra (R$)</label><input type="number" step="0.01" id="pcValorExtra" value="0"></div>
                <div class="field"><label>Adiant. (R$)</label><input type="number" step="0.01" id="pcAdiant" value="0"></div>
                <div class="field"><label>Deve Anterior (R$)</label><input type="number" step="0.01" id="pcDeveAnterior" value="0"></div>
                <div class="field"><label>D√≠vida (R$)</label><input type="number" step="0.01" id="pcDivida" value="0"></div>
                <div class="field"><label>Cr√©dito (R$)</label><input type="number" step="0.01" id="pcCredito" value="0"></div>
              </div>
              <div class="row">
                <div class="field"><label>Resultado (coletas - despesas)</label><input type="text" id="pcResultado" readonly></div>
                <div class="field"><label>Comiss√£o (%)</label><input type="text" id="pcPerc" readonly></div>
                <div class="field"><label>√Ä Pagar (R$)</label><input type="text" id="pcPagar" readonly></div>
                <div class="field"><label>Restam (R$)</label><input type="text" id="pcRestam" readonly></div>
              </div>
            </div>

            <!-- DESPESAS -->
            <h4 style="margin-top:10px">Despesas</h4>
            <table>
              <thead>
                <tr><th>FICHA</th><th>INFORMA√á√ïES</th><th>VALOR (R$)</th><th>A√ß√µes</th></tr>
              </thead>
              <tbody id="pcDespesasBody"></tbody>
              <tfoot>
                <tr><th colspan="2">TOTAL DESPESAS</th><th id="pcTotalDespesas">R$ 0,00</th><th></th></tr>
              </tfoot>
            </table>
            <div class="pc-actions">
              <button class="btn" id="btnPcAddDespesa">Adicionar Despesa</button>
              <button class="btn ghost" id="btnPcLimpar">Limpar Despesas</button>
            </div>
          </div>

<!-- COLUNA DIREITA -->
<div class="pc-box right-box">

  <!-- Pagamentos ‚Äî Vales (somente leitura) -->
  <div class="card" style="margin-top:10px">
    <h4>Pagamentos ‚Äî Vales</h4>
    <div style="max-height:220px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Valor</th>
            <th>C√≥d. Vale</th>
            <th>Obs</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="pgVBody"></tbody>
        <tfoot>
          <tr><th colspan="1">Total Vales</th><th id="pgVTotal">R$ 0,00</th><th colspan="3"></th></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Pagamentos ‚Äî Normais (PIX / DINHEIRO / CART√ÉO / ADIANTAMENTO) -->
  <div class="card" style="margin-top:10px">
    <h4>Pagamentos ‚Äî Normais (PIX / Dinheiro / Cart√£o / Adiantamento)</h4>

    <div class="form-grid" id="pgFormN" style="grid-template-columns:1fr 1fr 1fr 1fr">
      <label>Data
        <input type="date" id="pgNData" />
      </label>
      <label>Valor (R$)
        <input type="number" step="0.01" id="pgNValor" placeholder="0,00" />
      </label>
      <label>Forma
        <select id="pgNForma">
          <option>PIX</option>
          <option>DINHEIRO</option>
          <option>CART√ÉO</option>
          <option >DEP√ìSITO</option>
          <option>ADIANTAMENTO</option>
          <option>DIVIDA_PAGA</option>
        </select>
      </label>
      <label>Obs
        <input type="text" id="pgNObs" placeholder="opcional" />
      </label>
    </div>

    <div class="pc-actions" style="margin-top:8px">
      <button class="btn" id="btnPgNAdd">Adicionar pagamento</button>
      <button class="btn ghost" id="btnPgNLimpar">Limpar lista</button>
    </div>

    <div style="max-height:220px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>Data</th><th>Valor</th><th>Forma</th><th>Obs</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="pgNBody"></tbody>
        <tfoot>
          <tr><th colspan="1">TOTAL PAGO</th><th id="pgNTotal">R$ 0,00</th><th colspan="3"></th></tr>
        </tfoot>
      </table>
    </div>
  </div>

<script>
// ‚úÖ Preenche data automaticamente com hoje
document.addEventListener('DOMContentLoaded', function() {
  const hoje = new Date().toISOString().slice(0,10);
  const dataDivida = document.getElementById('pgDivData');
  if (dataDivida && !dataDivida.value) {
    dataDivida.value = hoje;
  }
});

// ‚úÖ Fun√ß√£o para adicionar pagamento de d√≠vida
function pgDivAddFromForm(){
  const data  = document.getElementById('pgDivData').value || new Date().toISOString().slice(0,10);
  const valor = Number(document.getElementById('pgDivValor').value || 0);
  const obs   = (document.getElementById('pgDivObs').value || '').trim();

  if (!valor || valor<=0){ 
    alert('Informe um valor v√°lido (>0).'); 
    return; 
  }

  // ‚úÖ Adiciona como pagamento DIVIDA_PAGA
  (prestacaoAtual.pagamentos ||= []).push({ 
    id: uid(), 
    data, 
    valor, 
    forma: 'DIVIDA_PAGA', 
    obs 
  });

  // Limpa campos
  document.getElementById('pgDivValor').value = '';
  document.getElementById('pgDivObs').value   = '';

  pgDivRender();
  pcSchedule(); // ‚úÖ Recalcula RESTAM
}

// ‚úÖ Wire dos bot√µes (j√° est√° no seu prestacoes.js, mas inclui aqui tamb√©m)
(function() {
  const btnAdd = document.getElementById('btnPgDivAdd');
  if (btnAdd && !btnAdd.__pcWired) {
    btnAdd.__pcWired = true;
    btnAdd.addEventListener('click', pgDivAddFromForm);
  }

  const btnLimpar = document.getElementById('btnPgDivLimpar');
  if (btnLimpar && !btnLimpar.__pcWired) {
    btnLimpar.__pcWired = true;
    btnLimpar.addEventListener('click', function() {
      if(!confirm('Limpar todos os pagamentos de d√≠vida desta presta√ß√£o?')) return;
      prestacaoAtual.pagamentos = (prestacaoAtual.pagamentos||[]).filter(p => 
        (p.forma||'').toUpperCase()!=='DIVIDA_PAGA'
      );
      pgDivRender();
      pcSchedule();
    });
  }
})();
</script>

  <!-- Vales do gerente (banco geral) -->
  <div class="card" style="margin-top:10px">
    <h4>Vales do gerente (banco geral)</h4>
    <form id="formVale" class="form-grid" style="grid-template-columns:1fr 1fr 2fr 1fr">
      <label>C√≥digo/Ref.
        <input name="cod" placeholder="ex.: 5125 / vendedor" />
      </label>
      <label>Valor (R$)
        <input name="valor" inputmode="decimal" placeholder="0,00" />
      </label>
      <label>Obs (mensal/semana, acordo etc.)
        <input name="obs" placeholder="n√£o desconta autom√°tico" />
      </label>
      <label>Per√≠odo
        <input name="periodo" placeholder="ex.: 2025-08" />
      </label>
      <div style="grid-column:1/-1;display:flex;justify-content:flex-end;margin-top:6px">
        <button class="btn" type="submit">Adicionar vale</button>
      </div>
    </form>

    <div style="max-height:240px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;margin-top:8px">
      <table>
        <thead>
          <tr><th>Ref.</th><th>Valor</th><th>Obs/Per√≠odo</th><th>Descontar agora</th><th>A√ß√µes</th></tr>
        </thead>
        <tbody id="pcValesBody"></tbody>
        <tfoot>
          <tr><th colspan="3" style="text-align:right">Total a descontar</th><th id="pcValesTotalDesc">R$ 0,00</th><th></th></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- A√ß√µes e Canvas -->
  <div class="pc-actions" style="margin-top:10px">
    <button class="btn" id="btnPcPng">Gerar imagem (PNG)</button>
    <button class="btn ghost" id="btnPcSalvar">Salvar presta√ß√£o</button>
  </div>

  <canvas id="pcCanvas" width="1200" height="900"
    style="display:block;width:100%;border:1px solid #ddd;border-radius:8px"></canvas>
</div>

    </section>
            <!-- ====== SUBP√ÅGINA: RELAT√ìRIOS DE PRESTA√á√ïES ====== -->
            <section id="pagePrestRel" class="container hidden" data-perm="prest_rel_view">
              <h2>Relat√≥rios de Presta√ß√µes de Contas</h2>
            
              <div class="filters" id="relFiltroPeriodo" style="margin-bottom:10px">
                <div class="field">
                  <label>De</label>
                  <input type="date" id="relDe">
                </div>
                <div class="field">
                  <label>At√©</label>
                  <input type="date" id="relAte">
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <button id="btnRelAplicar" class="btn">Aplicar</button>
                </div>
              </div>
            
              <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:12px">
                <table id="tblRelatorios">
                  <thead>
                    <tr>
                      <th>Gerente</th>
                      <th>Per√≠odo</th>
                      <th>Total Coletas</th>
                      <th>Total Despesas</th>
                      <th>√Ä Pagar</th>
                      <th>Pagos</th>
                      <th>Em Aberto</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyRelatorios"></tbody>
                </table>
              </div>
            </section>
            
            <!-- ====== SUBP√ÅGINA: PRESTA√á√ïES FINALIZADAS ====== -->
            <section id="pagePrestFech" class="container hidden" data-perm="prest_fech_view">
              <h2>Presta√ß√µes Finalizadas</h2>
            
              <div class="filters" style="margin-bottom:10px">
                <div class="field">
                  <label>De</label>
                  <input type="date" id="fechDe">
                </div>
                <div class="field">
                  <label>At√©</label>
                  <input type="date" id="fechAte">
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <button id="btnFechAplicar" class="btn">Aplicar</button>
                </div>
              </div>
            
              <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:12px">
                <table>
                  <thead>
                    <tr>
                      <th>Gerente</th>
                      <th>Per√≠odo</th>
                      <th>Total Coletas</th>
                      <th>Total Despesas</th>
                      <th>√Ä Pagar</th>
                      <th>Pagos</th>
                      <th>Em Aberto</th>
                      <th>A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyFechadas"></tbody>
                </table>
              </div>
            </section>

<!-- === ABA: PRESTA√á√ïES / VALES === -->
<section id="pagePrestVales" class="container hidden" data-perm="prest_vales_view">
  <div class="card">
    <div class="card-head" style="display:flex;align-items:center;gap:12px;justify-content:space-between">
      <h2 style="margin:0">Vales</h2>
      <div id="vlsActions" style="display:flex;gap:8px">
        <button id="vlsBtnNovo" class="btn">Novo vale</button>
      </div>
    </div>

    <div class="row" style="display:flex;flex-wrap:wrap;gap:12px;margin:12px 0">
      <label>Gerente
        <select id="vlsFiltroGerente" style="min-width:260px">
          <option value="">Todos</option>
        </select>
      </label>
      <label>Buscar
        <input id="vlsBusca" placeholder="c√≥digo / obs" />
      </label>
      <span style="opacity:.7">Empresa atual respeita o seletor do topo</span>
    </div>

    <div style="border:1px solid #eee;border-radius:12px;overflow:auto">
      <table class="table" id="vlsTabela" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left;padding:10px">Gerente</th>
            <th style="text-align:left;padding:10px">C√≥digo</th>
            <th style="text-align:right;padding:10px">Saldo (R$)</th>
            <th style="text-align:left;padding:10px">Obs</th>
            <th style="text-align:left;padding:10px">Per√≠odo</th>
            <th style="text-align:left;padding:10px">Status</th>
            <th style="text-align:right;padding:10px">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="vlsTBody">
          <tr><td colspan="7" style="padding:12px">Carregando‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Dialog: Novo Vale -->
  <dialog id="dlgVlsNovo" class="pc" style="border:none;border-radius:16px;padding:0;max-width:520px;width:92vw">
    <div class="pc-head" style="background:#111;color:#fff;padding:12px 20px;font-weight:700">Novo vale</div>
    <form id="vlsForm" class="pc-box" method="dialog" style="padding:18px 20px">
      <div class="pc-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <label class="col-2">Gerente
          <select id="vlsGerente" required></select>
        </label>
        <label>C√≥digo
          <input id="vlsCod" placeholder="ex.: 8403" required>
        </label>
        <label>Valor (R$)
          <input id="vlsValor" type="number" step="0.01" min="0.01" required>
        </label>
        <label class="col-2">Obs
          <input id="vlsObs" placeholder="ex.: semanal / acordo">
        </label>
        <label>Per√≠odo
          <input id="vlsPeriodo" placeholder="aaaa-mm">
        </label>
      </div>
      <div class="pc-actions" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 20px;border-top:1px solid #eee">
        <button value="cancel" type="reset" class="btn ghost">Cancelar</button>
        <button id="vlsSalvar" class="btn" type="button">Salvar</button>
      </div>
    </form>
  </dialog>
</section>


    <!-- ====== P√ÅGINA: FINANCEIRO ====== -->
    <section id="pageFinanceiro" class="container hidden" data-perm="financeiro_view">
      <div id="secaoPendencias" style="margin-bottom: 30px;">
        <h2 style="
          font-size: 24px; 
          margin-bottom: 16px; 
          color: #111;
          display: flex;
          align-items: center;
          gap: 10px;
        ">
          <span>‚è≥</span> Pend√™ncias de Confirma√ß√£o
        </h2>
        <div id="finPendenciasBox" style="
          border: 2px solid #e5e7eb;
          border-radius: 12px;
          padding: 20px;
          background: #f9fafb;
          min-height: 100px;
        ">
          <p style="text-align: center; color: #666; padding: 40px 0;">
            Carregando pend√™ncias...
          </p>
        </div>
      </div>

      <div class="finance-buttons" style="margin-bottom:12px; display:flex; gap:10px;">


        <button class="btn" onclick="imprimirFinanceiroA4()">Imprimir Tabela</button>
        <button class="btn" onclick="__fin_printCaixa()">Imprimir Caixa</button>
        <button id="btnNovo" type="button" class="btn primary">Novo lan√ßamento</button>
      </div>
      

      <section class="cards" aria-label="Resumo financeiro">
        <article class="card card-fin r">
          <small>TOTAL RECEBIMENTOS</small>
          <div class="big" id="totalRecebimentos">R$ 0,00</div>
        </article>
        <article class="card card-fin p">
          <small>TOTAL PAGAMENTOS</small>
          <div class="big" id="totalPagamentos">R$ 0,00</div>
        </article>
        <article class="card card-fin s">
          <small>SALDO</small>
          <div class="big" id="saldo">R$ 0,00</div>
        </article>
      </section>

      <section class="filters" aria-label="Filtros">
        <div class="field">
          <label for="mes">M√äS</label>
          <select id="mes">
            <option value="">Todos</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            <option>7</option><option>8</option><option selected>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
        <div class="field">
          <label for="ano">ANO</label>
          <input id="ano" type="number" value="2025" />
        </div>
        <div class="field">
          <label for="status">PAGAMENTO</label>
          <select id="status">
            <option value="">Todos</option>
            <option>RECEBIDO</option>
            <option>PAGO</option>
          </select>
        </div>
        <div class="field">
          <label for="forma">FORMA DE PGTO.</label>
          <select id="forma">
            <option value="">Todas</option>
            <option>PIX</option>
            <option>DINHEIRO</option>
            <option>CART√ÉO</option>
          </select>
        </div>
        <div class="field">
          <label for="busca">BUSCAR (Gerente/Rota, Categoria)</label>
          <input id="busca" type="search" placeholder="ex.: DIEGO, PRESTA√á√ÉO‚Ä¶" />
        </div>
        <div class="field">
          <label for="dataDe">DATA DE</label>
          <input id="dataDe" type="date" />
        </div>
        <div class="field">
          <label for="dataAte">DATA AT√â</label>
          <input id="dataAte" type="date" />
        </div>
      </section>

      <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:12px">
        <table id="tabela">
          <thead>
            <tr>
              <th data-key="gerente">GERENTE/ROTA</th>
              <th data-key="valor" style="min-width:120px">VALOR</th>
              <th data-key="status">RECEBIDO/PAGO</th>
              <th data-key="forma">FORMA DE PGM</th>
              <th data-key="categoria">CATEGORIA</th>
              <th data-key="data" style="min-width:120px">DATA</th>
              <th id="thAcoes" style="min-width:140px">A√á√ïES</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ====== P√ÅGINA: DESPESAS ====== -->
    <section id="pageDespesas" class="container hidden" data-perm="despesas_view">
      <h2>Despesas</h2>
      <div class="filters">
        <div class="field">
          <label>Gerente</label>
<input id="despBuscaGerente" list="listGerentes" placeholder="nome/rota">
<datalist id="listGerentes"></datalist>
        </div>
        <div class="field">
          <label>Rota</label>
          <input id="despBuscaRota" list="listRotas" placeholder="ex.: 003 VX">
<datalist id="listRotas"></datalist>
        </div>
        <div class="field">
          <label>Ficha</label>
          <input id="despBuscaFicha" list="listFichas" placeholder="ex.: 0301">
<datalist id="listFichas"></datalist>
        </div>
        <div class="field">
          <label>De</label>
          <input id="despDe" type="date" />
        </div>
        <div class="field">
          <label>At√©</label>
          <input id="despAte" type="date" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="despExport" class="btn">Exportar CSV</button>
          <label class="field" style="flex-direction:row;align-items:center;gap:6px">
            <input type="checkbox" id="despMostrarOcultas">
            Mostrar ocultas
          </label>
          
        </div>
      </div>
      <div class="scroll-wrap">
        <!-- barra superior -->
        <div class="scroll-top" id="despScrollTop">
          <div class="scroll-ghost"></div>
        </div>
      <!-- Aviso de despesas ocultadas -->
<p id="despAvisoOcultas" class="hidden desp-aviso"></p>

        <!-- tabela com barra inferior -->
        <div class="scroll-main" id="despScrollMain">
          <table id="tblDespesas">
            <thead>
              <tr>
                <th>Gerente</th>
                <th>Rota</th>
                <th>Ficha</th>
                <th>Informa√ß√µes</th>
                <th>Valor Ajuda</th>
                <th>Ideal</th>
                <th>Diferen√ßa</th>
                <th>Status</th>
                <th>Venda Bruta</th>
                <th>Venda L√≠quida</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyDespesas"></tbody>
          </table>
        </div>
      </div>      
    </section>

    <!-- ====== P√ÅGINA: FICHAS ====== -->
    <section id="pageFichas" class="container hidden" data-perm="cad_fichas_view">
      <h2>Fichas ‚Äì Cadastro e Vendas</h2>

      <div class="grid">
        <!-- Cadastro Ficha ‚Üî √Årea -->
        <div class="card">
          <h3>Cadastro de Ficha ‚Üî √Årea</h3>
          <form id="formFichaArea" class="form-grid">
            <label>Ficha
              <input name="ficha" required placeholder="ex.: 0301" />
            </label>
            <label>√Årea
              <input name="area" required placeholder="ex.: 003 VX" />
            </label>
            <div style="grid-column:1/-1;display:flex;justify-content:flex-end;gap:10px">
              <button class="btn ghost" type="reset">Limpar</button>
              <button class="btn" type="submit">Salvar</button>
            </div>
          </form>
          <div style="max-height:260px;overflow:auto;margin-top:10px;border:1px solid #e5e7eb;border-radius:10px">
            <table>
              <thead><tr><th>Ficha</th><th>√Årea</th><th>A√ß√µes</th></tr></thead>
              <tbody id="tbodyFichaArea"></tbody>
            </table>
          </div>
        </div>

<!-- IMPORTAR VENDAS (XLSX/CSV) -->
 

<div class="card" style="margin-bottom:12px">
  <h2>Importa√ß√µes</h2>
  <h3>Importar vendas (XLSX/CSV)</h3>
  <p style="margin:6px 0 10px;color:#374151">
    O arquivo deve conter colunas: <strong>ficha</strong>, <strong>mes</strong> (AAAA-MM), 
    <strong>bruta</strong>, <strong>liquida</strong>.
  </p>
  <div class="row" style="align-items:end; gap:10px;">
    <div class="field">
      <label>Arquivo
        <input type="file" id="inpImportVendas" accept=".xlsx,.xls,.csv" />
      </label>
    </div>
    <button class="btn" id="btnImportVendas">Importar</button>
    <button class="btn ghost" id="btnModeloVendas">Baixar modelo</button>
  </div>
  <small id="impHintVendas" style="color:#6b7280;display:block;margin-top:8px"></small>

  <!-- IMPORTAR FICHA ‚Üî √ÅREA (XLSX/CSV) -->
<!-- Importar Ficha ‚Üî √Årea -->
<div class="card" style="margin-bottom:12px">
  <h3>Importar Ficha ‚Üî √Årea (XLSX/CSV)</h3>
  <div class="row" style="align-items:end; gap:10px;">
    <div class="field">
      <label>Arquivo
        <input type="file" id="inpImportFichaArea" accept=".xlsx,.xls,.csv" />
      </label>
    </div>
    <button class="btn" id="btnImportFichaArea">Importar</button>
  </div>
  <small style="color:#6b7280;display:block;margin-top:8px">
    Colunas aceitas: <strong>ficha</strong>, <strong>area</strong> (ou ‚Äú√°rea‚Äù/‚Äúrota‚Äù).
  </small>
</div>


        <!-- Cadastro Vendas Mensais -->
        <div class="card">
          <h3>Cadastro de Venda Mensal</h3>
          <form id="formFichaVenda" class="form-grid">
            <label>Ficha
              <select name="ficha" id="selFichaVenda" required></select>
            </label>        
            <label>M√™s (AAAA-MM)
              <input name="mes" type="month" required />
            </label>
            <label>Venda Bruta (R$)
              <input name="bruta" inputmode="decimal" required placeholder="ex.: 10000,00" />
            </label>
            <label>Venda L√≠quida (R$)
              <input name="liquida" inputmode="decimal" placeholder="opcional" />
            </label>
            <div style="grid-column:1/-1;display:flex;justify-content:flex-end;gap:10px">
              <button class="btn ghost" type="reset">Limpar</button>
              <button class="btn" type="submit">Salvar</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Vendas por Ficha</h3>
    
        <div class="filters">
          <div class="field"><label>Ficha</label><input id="fvBuscaFicha" placeholder="ex.: 0301" /></div>
          <div class="field"><label>√Årea</label><input id="fvBuscaArea" placeholder="ex.: 003 VX" /></div>
          <div class="field"><label>De</label><input id="fvDe" type="month" /></div>
          <div class="field"><label>At√©</label><input id="fvAte" type="month" /></div>
          <div class="field"><label>&nbsp;</label><button id="fvExport" class="btn">Exportar CSV</button></div>
          <div style="margin-top:10px">
          </div>    
        </div>
        <div id="vendasWrap" style="overflow:auto;border:1px solid #e5e7eb;border-radius:10px">
          <table id="tblVendas">
            <thead>
              <tr><th>Ficha</th><th>√Årea</th><th>M√™s</th><th>Bruta</th><th>L√≠quida</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="tbodyVendas"></tbody>
          </table>
        </div>
      </div>
    </section>


  <!-- DIALOG: Novo lan√ßamento -->
  <dialog id="dlgLanc">
    <header class="card"><strong>Novo lan√ßamento</strong></header>
    <form id="formLanc" class="card" style="margin:0">
      <div class="form-grid">
        <label>Gerente/Rota
          <input name="gerente" required placeholder="ex.: 034 DIEGO" />
        </label>
        <label>Valor (R$)
          <input name="valor" inputmode="decimal" required placeholder="ex.: 1215,00" />
        </label>
        <label>Status
          <select name="status" required>
            <option>RECEBIDO</option>
            <option>PAGO</option>
          </select>
        </label>
        <label>Forma
          <select name="forma" required>
            <option>PIX</option>
            <option>DINHEIRO</option>
            <option>CART√ÉO</option>
          </select>
        </label>
        <label>Categoria
          <input name="categoria" required placeholder="ex.: PRESTA√á√ÉO DE CONTAS" />
        </label>
        <label>Data
          <input name="data" type="date" required />
        </label>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px">
        <button class="btn secondary" type="button" id="btnCloseDlg">Cancelar</button>
        <button class="btn" id="salvarLanc" type="button">Salvar</button>
      </div>
    </form>
  </dialog>
</main>
</div> 
</section> 

<!-- ===== P√ÅGINA DE HIST√ìRICO/AUDITORIA ===== -->
<!-- Adicionar no index.html junto com as outras sections -->

<section id="pageHistorico" class="container hidden" data-perm="admin_only">
  <div class="card">
    <h2>üìú Hist√≥rico do Sistema</h2>
    
    <!-- Filtros -->
    <div class="filters" style="display:flex;gap:10px;margin:20px 0;">
      <div class="field">
        <label>Usu√°rio</label>
        <select id="auditFilterUser">
          <option value="">Todos</option>
        </select>
      </div>
      
      <div class="field">
        <label>Empresa</label>
        <select id="auditFilterCompany">
          <option value="">Todas</option>
          <option value="BSX">BSX</option>
          <option value="BETPLAY">BetPlay</option>
          <option value="EMANUEL">Emanuel</option>
        </select>
      </div>
      
      <div class="field">
        <label>A√ß√£o</label>
        <input id="auditFilterAction" type="text" placeholder="Ex: gerente, prestacao">
      </div>
      
      <div class="field">
        <label>Data Inicial</label>
        <input id="auditFilterStart" type="date">
      </div>
      
      <div class="field">
        <label>Data Final</label>
        <input id="auditFilterEnd" type="date">
      </div>
    </div>
    
    <!-- A√ß√µes -->
    <div style="display:flex;gap:10px;margin-bottom:20px;">
      <button id="btnAuditFilter" class="btn primary">üîç Filtrar</button>
      <button id="btnAuditExport" class="btn">üì• Exportar CSV</button>
      <button id="btnAuditClear" class="btn danger">üóëÔ∏è Limpar Antigos</button>
    </div>
    
    <!-- Estat√≠sticas -->
    <div id="auditStats" style="display:flex;gap:20px;margin-bottom:20px;">
      <div class="card-fin">
        <div class="label">Total de Registros</div>
        <div class="big" id="auditTotal">0</div>
      </div>
      <div class="card-fin">
        <div class="label">Hoje</div>
        <div class="big" id="auditToday">0</div>
      </div>
      <div class="card-fin">
        <div class="label">Esta Semana</div>
        <div class="big" id="auditWeek">0</div>
      </div>
    </div>
    
    <!-- Tabela -->
    <div class="table-wrap" style="max-height:600px;overflow:auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Usu√°rio</th>
            <th>Empresa</th>
            <th>A√ß√£o</th>
            <th>Detalhes</th>
          </tr>
        </thead>
        <tbody id="auditTableBody">
          <tr><td colspan="5">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<section>
<script>
// ===== C√ìDIGO DA P√ÅGINA DE HIST√ìRICO =====
(function() {
  'use strict';
  
  const page = document.getElementById('pageHistorico');
  if (!page) return;
  
  const tbody = page.querySelector('#auditTableBody');
  const totalEl = page.querySelector('#auditTotal');
  const todayEl = page.querySelector('#auditToday');
  const weekEl = page.querySelector('#auditWeek');
  
  // ===== RENDERIZAR TABELA =====
  function render(logs) {
    if (!logs || logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5">Nenhum registro encontrado</td></tr>';
      return;
    }
    
    tbody.innerHTML = logs.map(log => {
      const date = new Date(log.timestamp);
      const detailsStr = JSON.stringify(log.details, null, 2);
      
      return `
        <tr>
          <td>${date.toLocaleString('pt-BR')}</td>
          <td><strong>${log.user.username}</strong><br><small>${log.user.role}</small></td>
          <td>${log.company}</td>
          <td><span class="badge">${log.action}</span></td>
          <td><pre style="font-size:11px;margin:0;">${detailsStr}</pre></td>
        </tr>
      `;
    }).join('');
  }
  
  // ===== CALCULAR ESTAT√çSTICAS =====
  function updateStats(logs) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    const todayCount = logs.filter(l => new Date(l.timestamp) >= today).length;
    const weekCount = logs.filter(l => new Date(l.timestamp) >= weekAgo).length;
    
    totalEl.textContent = logs.length;
    todayEl.textContent = todayCount;
    weekEl.textContent = weekCount;
  }
  
  // ===== POPULAR SELECT DE USU√ÅRIOS =====
  function populateUserSelect() {
    const select = page.querySelector('#auditFilterUser');
    const users = window.UserAuth?.list() || [];
    
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.username;
      opt.textContent = u.username;
      select.appendChild(opt);
    });
  }
  
  // ===== CARREGAR DADOS =====
  function loadData() {
    if (typeof window.AuditLog === 'undefined') {
      tbody.innerHTML = '<tr><td colspan="5">Sistema de auditoria n√£o carregado</td></tr>';
      return;
    }
    
    const filters = {
      username: page.querySelector('#auditFilterUser')?.value || undefined,
      company: page.querySelector('#auditFilterCompany')?.value || undefined,
      action: page.querySelector('#auditFilterAction')?.value || undefined,
      startDate: page.querySelector('#auditFilterStart')?.value || undefined,
      endDate: page.querySelector('#auditFilterEnd')?.value || undefined
    };
    
    // Remove campos vazios
    Object.keys(filters).forEach(k => {
      if (!filters[k]) delete filters[k];
    });
    
    const logs = window.AuditLog.getLogs(filters);
    render(logs);
    updateStats(logs);
  }
  
  // ===== EVENTOS =====
  page.querySelector('#btnAuditFilter')?.addEventListener('click', loadData);
  
  page.querySelector('#btnAuditExport')?.addEventListener('click', () => {
    if (typeof window.AuditLog === 'undefined') {
      alert('Sistema de auditoria n√£o carregado');
      return;
    }
    
    const filters = {
      username: page.querySelector('#auditFilterUser')?.value || undefined,
      company: page.querySelector('#auditFilterCompany')?.value || undefined,
      action: page.querySelector('#auditFilterAction')?.value || undefined,
      startDate: page.querySelector('#auditFilterStart')?.value || undefined,
      endDate: page.querySelector('#auditFilterEnd')?.value || undefined
    };
    
    Object.keys(filters).forEach(k => {
      if (!filters[k]) delete filters[k];
    });
    
    window.AuditLog.exportLogs(filters);
  });
  
  page.querySelector('#btnAuditClear')?.addEventListener('click', () => {
    if (!confirm('Deseja limpar registros com mais de 90 dias?')) return;
    
    if (typeof window.AuditLog === 'undefined') {
      alert('Sistema de auditoria n√£o carregado');
      return;
    }
    
    const removed = window.AuditLog.clearOldLogs(90);
    alert(`${removed} registros removidos`);
    loadData();
  });
  
  // ===== INICIALIZAR =====
  populateUserSelect();
  
  // Carregar quando a p√°gina for mostrada
  window.addEventListener('hashchange', () => {
    if (location.hash === '#historico' || location.hash === '#audit') {
      loadData();
    }
  });
  
  // Se j√° est√° na p√°gina
  if (location.hash === '#historico' || location.hash === '#audit') {
    loadData();
  }
})();
</script>
</section>
      
  <!-- JS: manter apenas UMA lib XLSX para evitar conflitos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>



<!-- JS externo -->

<script src="js/utils.js"></script>
<script src="js/empresa-shim.js"></script>
<script src="js/auth-rbac.js" ></script>
<script src="js/api-supabase.js"></script>
<script src="js/prestacoes-supabase.js" defer></script>
<script src="js/supabase-init.js"></script>
<script src="js/config-supabase.js"></script>
<script src="js/auth-supabase-adapter.js"></script>
<script src="js/sync-manager.js" defer></script>
<script src="js/nav.js" ></script>
<script src="js/core.js" defer></script>
<script src="js/gerentes.js"></script>
<script src="js/fichas.js" defer></script>
<script src="js/saldo-acumulado.js"></script>
<script src="js/saldo-acumulado-ui.js"></script>
<script src="ajuste-saldo-manual.js"></script>
<script src="js/prestacoes.js" defer></script>
<script src="js/gerentes-loader.js"></script>
<script src="js/relatorios.js" defer></script>
<script src="js/financeiro.js" defer></script>
<script src="js/despesas.js" defer></script>
<script src="js/dashboard.js" defer></script>
<script src="js/users-page.js" defer></script>
<script src="js/auth.js" defer></script>
<script src="js/boot.js" defer></script>
<script src="js/ai.js" defer></script>
<script src="js/audit-log.js"></script>
<script src="js/audit-auto.js"></script>
<script src="js/historico.js" defer></script>
<script src="alertas-scroll-indicator.js"></script>




  <script>
    // garante que o bot√£o "Cancelar" fecha o dialog em todos os navegadores
    document.getElementById('btnCloseDlg')?.addEventListener('click', ()=> {
      document.getElementById('dlgLanc')?.close();
    });
  </script>
<aside id="aiPanel" class="ai is-hidden" aria-label="Assistente IA">
  <header class="ai__head" id="aiDragHandle">
    <div class="ai__title">
      <strong>Assistente IA</strong>
      <small id="aiCompanyTag"></small>
    </div>
    <div class="ai__actions">
      <button id="aiPin" class="btn ghost" title="Ancorar/desancorar">üìå</button>
      <button id="aiClear" class="btn ghost" title="Limpar conversa">üßπ</button>
      <button id="aiClose" class="btn ghost" title="Fechar">Fechar</button>
    </div>
  </header>

  <div id="aiMsgs" class="ai__msgs" role="log" aria-live="polite"></div>

  <div class="ai__typing is-hidden" id="aiTyping">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </div>

  <footer class="ai__footer">
    <div id="aiChips" class="ai__chips"></div>
    <form id="aiForm" class="ai__form" autocomplete="off">
      <input id="aiInput" placeholder="Pergunte‚Ä¶ (Enter envia, Shift+Enter quebra linha)" />
      <button class="btn" id="aiSend" type="submit">Enviar</button>
    </form>
  </footer>

  <div class="ai__resize" id="aiResizeHandle" title="Redimensionar"></div>
</aside>

<script>
  // 1) Quando clicar na aba "Vales", dispara o init da p√°gina
  document.addEventListener('click', (e)=>{
    if (e.target.closest('[data-tab="prest-vales"]')) {
      // d√° tempo do roteador mostrar a se√ß√£o
      setTimeout(()=>{ if (window.vlsInit) window.vlsInit(); }, 0);
    }
  });

  // 2) Como passamos a criar vales s√≥ na nova p√°gina,
  //    esconda o formul√°rio de cria√ß√£o na tela "Lan√ßar presta√ß√£o"
  document.addEventListener('DOMContentLoaded', ()=>{
    window.VALES_PAGE_ENABLED = true; // flag global usada pelo m√≥dulo de vales
    const formVale = document.getElementById('formVale');
    if (formVale) formVale.style.display = 'none'; // mant√©m a listagem/‚Äúdescontar agora‚Äù
  });
</script>

<script>
  // Mostra indicador ao sincronizar
  window.addEventListener('bsx:sync', (e) => {
    const indicator = document.getElementById('syncIndicator');
    if (indicator) {
      indicator.textContent = '‚úì ' + e.detail.type + ' atualizado';
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }
  });
  </script>

</body>
</html>